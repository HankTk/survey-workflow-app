<div class="survey-page">
  <mat-card class="page-header">
    <mat-card-header>
      <mat-card-title>アンケート管理</mat-card-title>
      <mat-card-subtitle>XMLデータから動的にアンケートUIを生成</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p>利用可能なアンケートから選択して読み込むか、サンプルアンケートを読み込みます。</p>
      
      <div class="survey-selection">
        <mat-form-field appearance="outline" class="survey-select">
          <mat-label>アンケートを選択</mat-label>
          <mat-select 
            [(ngModel)]="selectedSurveyId" 
            (selectionChange)="onSurveySelectionChange()"
            placeholder="アンケートを選択してください">
            <mat-option *ngFor="let surveyId of availableSurveys" [value]="surveyId">
              {{ surveyId === 'sample-survey.xml' ? 'サンプルアンケート' : surveyId }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <button mat-raised-button 
                color="primary" 
                (click)="loadSelectedSurvey()"
                [disabled]="isLoading || !selectedSurveyId">
          {{ isLoading ? '読み込み中...' : '選択したアンケートを読み込み' }}
        </button>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-button 
              (click)="clearSurvey()"
              [disabled]="!survey">
        クリア
      </button>
      <button mat-button 
              (click)="loadAvailableSurveys()"
              color="accent">
        一覧を更新
      </button>
      <button mat-button 
              (click)="deleteSelectedSurvey()"
              color="warn"
              [disabled]="!selectedSurveyId || selectedSurveyId === 'sample-survey.xml'">
        🗑️ 選択したサーベイを削除
      </button>
      <button mat-button 
              (click)="deleteAllSurveys()"
              color="warn">
        🗑️ すべてのサーベイを削除
      </button>
    </mat-card-actions>
  </mat-card>

  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>アンケートを読み込み中...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-card class="error-card">
      <mat-card-content>
        <h3>エラーが発生しました</h3>
        <p>{{ error }}</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="survey && !isLoading" class="survey-content">
    <app-dynamic-survey 
      [survey]="survey"
      (surveySubmitted)="onSurveySubmitted($event)">
    </app-dynamic-survey>
  </div>

  <div *ngIf="submittedResponses.length > 0" class="responses-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>送信された回答 ({{ submittedResponses.length }}件)</mat-card-title>
        <mat-card-subtitle>これまでに送信されたアンケート回答</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="responses-actions">
          <button mat-button color="warn" (click)="clearAllResponses()">
            すべての回答を削除
          </button>
        </div>
        <div *ngFor="let response of submittedResponses; let i = index" class="response-item">
          <div class="response-header">
            <h4>回答 {{ i + 1 }} - {{ response.submittedAt | date:'medium' }}</h4>
            <button mat-icon-button color="warn" (click)="deleteResponse(i)" class="delete-button">
              🗑️
            </button>
          </div>
          <div class="response-details">
            <div *ngFor="let item of response.responses" class="response-detail">
              <strong>{{ item.questionLabel || item.questionId }}:</strong> {{ item.value }}
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
